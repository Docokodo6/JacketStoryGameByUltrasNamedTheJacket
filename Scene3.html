<!DOCTYPE html>
<html lang="en" >
<head>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <title>Deliver the Jacket</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background-color: #0d0d0d;
      color: #fff;
      overflow: hidden;
    }
    canvas {
      display: block;
      background-color: #1a1a1a;
      margin: auto;
      border: 2px solid #333;
      border-radius: 16px;
      image-rendering: pixelated;
    }
#narratorBox {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    margin-top: 16px;
    padding: 10px 20px;
    background-color: rgba(20,20,20,0.9);
    border: 2px solid #333;
    border-radius: 12px;
    max-width: 640px;
    margin-left: auto;
    margin-right: auto;
    gap: 16px;
  }

  #narratorImg {
    width: 150px;
    height: 150px;
    object-fit: contain;
    image-rendering: pixelated;
  }

  #narratorText {
    font-family: 'Press Start 2P', cursive;
    font-size: 20px;
    line-height: 1.6;
    color: #eee;
    flex: 1;
    min-height: 64px;
    white-space: pre-wrap;
  }
    #logo {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      background: url('Logo.jpg') no-repeat center/contain;
    }
    #joystick {
      position: absolute;
      bottom: 80px;
      left: 20px;
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.05);
      border-radius: 50%;
      touch-action: none;
    }
    #stick {
      position: absolute;
      width: 40px;
      height: 40px;
      background: #aaa;
      border-radius: 50%;
      left: 30px;
      top: 30px;
    }
#endScreen {
  position: absolute;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0, 0, 0, 0.9);
  color: white;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  z-index: 10;
  font-family: 'Press Start 2P', cursive;
  white-space: pre-wrap;
  padding: 20px;
  text-align: center;
    }
    /* Overlay for black fade */
    #blackOverlay {
      position: absolute;
      top:0; left:0;
      width: 100vw;
      height: 100vh;
      background: black;
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s ease;
      z-index: 7;
    }
    /* Text on top of black overlay */
    #textOverlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-family: 'Press Start 2P', cursive;
      text-align: center;
      color: white;
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s ease;
      z-index: 8;
      max-width: 80vw;
    }
  </style>
</head>
<body>

<audio id="bgMusic" autoplay loop muted>
  <source src="MP3.pmp3" type="audio/mpeg">
</audio>

<div id="endScreen">"</div>
<div id="logo"></div>
<div id="joystick">
  <div id="stick"></div>
</div>

<div id="blackOverlay"></div>
<div id="textOverlay"></div>
<canvas id="game" width="640" height="360"></canvas>
<div id="narratorBox">
  <img id="narratorImg" src="Subject 8.png" alt="Narrator">
  <div id="narratorText"></div>
</div>
<script>
document.addEventListener("click", () => {
  const music = document.getElementById("bgMusic");
  music.muted = false;
  music.play();
});

const narratorLines = [
    "Oh there you are...where have you been!",
    "how is your ex hmmm?...Come here~",
    "Sometimes we need to let go ðŸ¥¹...its okay...dont worry...",
    "You'll find better than him...just come here to grandma"
  ];

  let narratorIndex = 0;
  const narratorText = document.getElementById("narratorText");

  function typeNarratorLine(line, speed = 30) {
    narratorText.textContent = "";
    let i = 0;
    function type() {
      if (i < line.length) {
        narratorText.textContent += line.charAt(i);
        i++;
        setTimeout(type, speed);
      }
    }
    type();
  }

  // Call this when you want to trigger a narrator message
  function showNarratorLine(index) {
    if (index < narratorLines.length) {
      typeNarratorLine(narratorLines[index]);
    }
  }

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const loadedImages = {
    background: new Image(),
    ground: new Image(),
    idle: new Image(),
    walk: [],
    house: new Image()
  };

  loadedImages.background.src = "Room.JPG"; // your sky/scenery PNG
  loadedImages.ground.src = "Floor.jpg";         // grass/dirt strip PNG

  loadedImages.idle.src = "Subject 3.png";
  ["Subject.png", "Subject 2.png", "Subject.png"].forEach((src, i) => {
    const img = new Image();
    img.src = src;
    loadedImages.walk[i] = img;
  });
  loadedImages.house.src = "Subject 6.png";

  let loadedCount = 0;
  const totalImages = 7;  // 5 original + 2 new

  function imageLoaded() {
    loadedCount++;
    if (loadedCount === totalImages) {
    }
  }

  loadedImages.background.onload = imageLoaded;
  loadedImages.ground.onload = imageLoaded;
  loadedImages.idle.onload = imageLoaded;
  loadedImages.house.onload = imageLoaded;
  loadedImages.walk.forEach(img => img.onload = imageLoaded);

  const girl = {
    x: 50,
    y: 260,
    width: 32,
    height: 48,
    frameIndex: 0,
    frameTimer: 0,
    frameDelay: 10,
    dir: "right",
    moving: false,
  };

  const houseX = 550, houseY = 230;
  let keys = {};
  let joyX = 0;
  let animationId;

  function loadFrame() {
    if (girl.moving) {
      girl.frameTimer++;
      if (girl.frameTimer >= girl.frameDelay) {
        girl.frameTimer = 0;
        girl.frameIndex = (girl.frameIndex + 1) % loadedImages.walk.length;
      }
    } else {
      girl.frameIndex = 0;
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // DRAW BACKGROUND LAYER FIRST (fills entire canvas)
    ctx.drawImage(loadedImages.background, 0,- 50, canvas.width, canvas.height);

    // DRAW GROUND STRIP AT BOTTOM
    ctx.drawImage(loadedImages.ground, 0, canvas.height - 0, canvas.width, 80);

    // THEN DRAW HOUSE & GIRL ON TOP
    ctx.drawImage(loadedImages.house, houseX, houseY, 38, 80);

    ctx.save();
    if (girl.dir === "left") {
      ctx.translate(girl.x + girl.width / 2, girl.y);
      ctx.scale(-1, 1);
      ctx.drawImage(
        girl.moving ? loadedImages.walk[girl.frameIndex] : loadedImages.idle,
        -girl.width / 2,
        0,
        girl.width,
        girl.height
      );
    } else {
      ctx.drawImage(
        girl.moving ? loadedImages.walk[girl.frameIndex] : loadedImages.idle,
        girl.x,
        girl.y,
        girl.width,
        girl.height
      );
    }
    ctx.restore();
  }

  // New pause & fade text system
  const steps = [
    { x: 150, text: "2 august...It's almost time...still need to move on" },
    { x: 250, text: "4 august...Will he...like it?...ill missed this jacket tho" },
    { x: 350, text: "6 august...its...Getting closer...I hate this...I still want to be together..." },
    { x: 470, text: "8 august...im scared but...Just ahead...I need to find out myselfðŸ’›" }
  ];

  let currentStep = 0;
  let isPaused = false;

  const blackOverlay = document.getElementById("blackOverlay");
  const textOverlay = document.getElementById("textOverlay");

  
  function update() {
    if (isPaused) {
      loadFrame();  // keep animation moving
      draw();
      animationId = requestAnimationFrame(update);
      return;
    }

    girl.moving = false;

    if (keys["ArrowRight"] || keys["d"] || joyX > 0.3) {
      girl.x += 2;
      girl.dir = "right";
      girl.moving = true;
    }
    if (keys["ArrowLeft"] || keys["a"] || joyX < -0.3) {
      girl.x -= 2;
      girl.dir = "left";
      girl.moving = true;
    }

    // pause and show text at steps
if (currentStep < steps.length && girl.x > steps[currentStep].x) {
  showNarratorLine(currentStep);
  currentStep++;
}
    if (girl.x > houseX - girl.width) {
      endGame();
      return;
    }

    loadFrame();
    draw();
    animationId = requestAnimationFrame(update);
  }

 function endGame() {
  // Optional fade-out animation
  blackOverlay.style.transition = "opacity 2s ease";
  blackOverlay.style.opacity = 1;

  setTimeout(() => {
    window.location.href = "scene4.html"; // NEW SCENE FILE NAME
  }, 2000);
}

  document.addEventListener("keydown", (e) => {
    keys[e.key] = true;
  });
  document.addEventListener("keyup", (e) => {
    keys[e.key] = false;
  });

  const joystick = document.getElementById("joystick");
  const stick = document.getElementById("stick");
  let dragging = false;

  joystick.addEventListener("touchstart", () => dragging = true);

  joystick.addEventListener("touchmove", (e) => {
    if (!dragging) return;
    const rect = joystick.getBoundingClientRect();
    const touch = e.touches[0];
    const dx = touch.clientX - rect.left - 50;
    const dy = touch.clientY - rect.top - 50;
    const dist = Math.min(Math.sqrt(dx * dx + dy * dy), 40);
    const angle = Math.atan2(dy, dx);
    const x = Math.cos(angle) * dist;
    const y = Math.sin(angle) * dist;
    stick.style.left = 30 + x + "px";
    stick.style.top = 30 + y + "px";
    joyX = x / 40;
  });

  joystick.addEventListener("touchend", () => {
    dragging = false;
    stick.style.left = "30px";
    stick.style.top = "30px";
    joyX = 0;
  });

update();
</script>
</body>
</html>